#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';
import { promisify } from 'node:util';
import { exec } from 'node:child_process';
import { Command } from 'commander';
import ora from 'ora';
import chalk from 'chalk';
import { remoteBuild } from "../build.js";
const program = new Command()
    .name('ui-extension-tools')
    .alias('uie')
    .description('Tools for managing and building HubSpot UI Extensions.');
const buildSteps = {
    lockfile: {
        start: 'Processing lockfile...',
        fn: generateLockfile,
        success: 'Lockfile ready',
        error: 'Error generating lockfile',
    },
    install: {
        start: 'Installing dependencies...',
        fn: installDeps,
        success: 'Dependencies installed',
        error: 'Error installing dependencies',
    },
    build: {
        start: 'Building remote extension...',
        fn: build,
        success: 'Extension build complete',
        error: 'Error building extension',
    },
};
program
    .option('-v, --profile-variables <path>', 'path to a json file with profile variables')
    .command('build <module>', { isDefault: true })
    .description('Build extension source code.')
    .action(async (module) => {
    const options = getOptions(module);
    await runCommand('lockfile', options);
    await runCommand('install', options);
    await runCommand('build', options);
});
program.parse(process.argv);
async function runCommand(command, options) {
    const { start, fn, success, error } = buildSteps[command];
    const spinner = ora();
    try {
        spinner.start(start);
        await fn(options);
        spinner.succeed(chalk.green(success));
    }
    catch (err) {
        spinner.fail(chalk.red(error));
        process.exit(1);
    }
    finally {
        spinner.stop();
    }
}
// Mirrors: https://git.hubteam.com/HubSpot/Artifactor/blob/f5cbea91d7a7dfb6278e878ae583e69022384fb5/ArtifactorFunctions/functions/node_18x/uie-remote-build/index.js#L59-L63
function build({ extensionRoot, extensionDist, entrypoint, profileVariables, }) {
    return remoteBuild({
        root: extensionRoot,
        entryPoint: entrypoint,
        outputDir: extensionDist,
        appConfig: {
            variables: profileVariables,
        },
    });
}
// Mirrors: https://git.hubteam.com/HubSpot/Artifactor/blob/f5cbea91d7a7dfb6278e878ae583e69022384fb5/ArtifactorFunctions/functions/node_18x/uie-remote-build/index.js#L53-L57
async function installDeps(options) {
    await execAsync('npm ci --ignore-scripts --no-audit --no-optional --no-fund', options);
}
// Mirrors: https://git.hubteam.com/HubSpot/Artifactor/blob/f5cbea91d7a7dfb6278e878ae583e69022384fb5/ArtifactorFunctions/functions/node_18x/uie-remote-build/index.js#L131-L136
async function generateLockfile(options) {
    const { extensionRoot, spinner } = options;
    if (fs.existsSync(path.join(extensionRoot, 'package-lock.json'))) {
        spinner.info('Existing lockfile found, skipping generation');
    }
    else {
        spinner.info('No lockfile found, generating...');
        await execAsync('npm install --package-lock-only', options);
    }
}
function getOptions(modulePath) {
    const entrypoint = path.isAbsolute(modulePath)
        ? modulePath
        : path.resolve(process.cwd(), modulePath);
    const extensionRoot = path.dirname(entrypoint);
    const extensionDist = path.join(extensionRoot, 'dist');
    const spinner = ora();
    // The Artifactor changes related to this are not yet available.
    // When it is, this will mirror the process where if applicable, a profile-variables.json file is available in the build bundle.
    const programOptions = program.opts();
    let profileVariables = {};
    if (programOptions.profileVariables) {
        const profileVariablePath = programOptions.profileVariables;
        const profileVariableFullPath = path.isAbsolute(profileVariablePath)
            ? profileVariablePath
            : path.resolve(process.cwd(), profileVariablePath);
        if (fs.existsSync(profileVariableFullPath) &&
            path.extname(profileVariableFullPath) === '.json') {
            profileVariables = JSON.parse(fs.readFileSync(profileVariableFullPath, 'utf-8'));
        }
    }
    return {
        extensionRoot,
        extensionDist,
        entrypoint,
        spinner,
        profileVariables,
    };
}
function execAsync(command, options) {
    return promisify(exec)(command, { cwd: options.extensionRoot });
}
