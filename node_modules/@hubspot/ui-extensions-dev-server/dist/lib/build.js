import { build } from 'vite';
import { ROLLUP_OPTIONS, OUTPUT_DIR } from "./constants.js";
import manifestPlugin from "./plugins/manifestPlugin.js";
import path from 'path';
import { getUrlSafeFileName } from "./utils.js";
import codeBlockingPlugin from "./plugins/codeBlockingPlugin.js";
import friendlyLoggingPlugin from "./plugins/friendlyLoggingPlugin.js";
const allowedExtensions = ['.js', '.ts', '.tsx', '.jsx'];
export const extensionErrorBaseMessage = `Supported file extensions are [${allowedExtensions.join(', ')}], received:`;
export async function buildSingleExtension({ file, outputDir = OUTPUT_DIR, emptyOutDir = true, minify = false, root = process.cwd(), // This is the vite default, so using that as our default
logLevel = 'info', appConfig, }) {
    const output = getUrlSafeFileName(file);
    await build({
        logLevel,
        root,
        define: {
            'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV || 'production'),
        },
        build: {
            lib: {
                entry: file,
                name: output,
                formats: ['iife'],
                fileName: () => output,
            },
            rollupOptions: {
                ...ROLLUP_OPTIONS,
                plugins: [
                    manifestPlugin({
                        output,
                        extensionPath: root,
                        logger: console,
                        manifestConfig: appConfig,
                    }),
                    friendlyLoggingPlugin({ logger: console }),
                    codeBlockingPlugin({ logger: console, extensionPath: root }),
                ],
            },
            outDir: outputDir,
            emptyOutDir,
            minify,
        },
    });
}
export async function remoteBuild(args) {
    const { root, entryPoint, outputDir = OUTPUT_DIR, logLevel, appConfig, } = args;
    if (!root) {
        console.error('remoteBuild Error: root is required');
        return;
    }
    if (!entryPoint) {
        console.error('remoteBuild Error: entryPoint is required');
        return;
    }
    const fileInfo = path.parse(entryPoint);
    if (!allowedExtensions.includes(fileInfo.ext)) {
        throw new Error(`${extensionErrorBaseMessage} ${fileInfo.ext}`);
    }
    await buildSingleExtension({
        file: entryPoint,
        outputDir,
        minify: true,
        root,
        logLevel,
        appConfig,
    });
}
