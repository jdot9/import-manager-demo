import { afterEach, describe, it, expect, vi, beforeEach } from 'vitest';
import * as devServer from '@hubspot/app-functions-dev-server';
import startDevServer from "../server.js";
import { DevServerState } from "../DevServerState.js";
import { createMockLogger, createDevServerConfig, createMockViteDevServer, } from "./factories.js";
const useMock = vi.fn();
vi.mock('@hubspot/app-functions-dev-server', () => ({
    AppProxyService: vi.fn(() => vi.fn((req, res, next) => next())),
    AppFunctionExecutionService: vi.fn(() => vi.fn((req, res, next) => next())),
}));
vi.mock('express', () => {
    const expressMock = () => ({
        use: useMock,
        get: vi.fn(),
        listen: (__, callback) => {
            // simulate async listen
            const serverMock = {
                on: vi.fn(function (event) {
                    if (event === 'error') {
                        // Don't call error handler in tests
                    }
                    return this;
                }),
                close: vi.fn((cb) => cb && cb()),
            };
            setTimeout(callback, 1);
            return serverMock;
        },
    });
    expressMock.static = vi.fn(() => vi.fn());
    return { default: expressMock };
});
describe('server', () => {
    let logger;
    let devServerConfig;
    beforeEach(() => {
        logger = createMockLogger();
        devServerConfig = createDevServerConfig(logger);
    });
    afterEach(() => {
        vi.resetAllMocks();
    });
    describe('startDevServer', () => {
        beforeEach(() => {
            useMock.mockClear();
            vi.mocked(devServer.AppFunctionExecutionService).mockReturnValue(vi.fn());
            vi.mocked(devServer.AppProxyService).mockReturnValue(vi.fn());
            vi.clearAllMocks();
        });
        it('should add the AppProxyService middleware when localDevUrlMapping is provided', async () => {
            const devServerState = new DevServerState({
                ...devServerConfig,
                localDevUrlMapping: {
                    'https://inbound.com': 'http://localhost',
                },
            });
            await startDevServer({
                devServerState,
                viteDevServer: createMockViteDevServer(),
            });
            expect(useMock).toHaveBeenNthCalledWith(3, '/api/crm-extensibility/execution/internal/v3', expect.any(Function), 
            // This is the AppProxyService middleware
            expect.any(Function));
            expect(devServer.AppProxyService).toHaveBeenCalledTimes(1);
            expect(devServer.AppProxyService).toHaveBeenCalledWith({
                accountId: devServerConfig.accountId,
                allowedUrls: [],
                localDevUrlMapping: devServerState.localDevUrlMapping,
                logger: devServerState.logger,
            });
        });
        it('should not add the AppProxyService middleware when the localDevUrlMapping is empty', async () => {
            const devServerState = new DevServerState({
                ...devServerConfig,
                localDevUrlMapping: {},
            });
            await startDevServer({
                devServerState,
                viteDevServer: createMockViteDevServer(),
            });
            expect(useMock).toHaveBeenNthCalledWith(3, '/api/crm-extensibility/execution/internal/v3', expect.any(Function));
            expect(devServer.AppProxyService).toHaveBeenCalledTimes(0);
        });
        it('should not add the AppProxyService middleware when localDevUrlMapping is not provided', async () => {
            const devServerState = new DevServerState({
                ...devServerConfig,
                localDevUrlMapping: undefined,
            });
            await startDevServer({
                devServerState,
                viteDevServer: createMockViteDevServer(),
            });
            expect(useMock).toHaveBeenNthCalledWith(3, '/api/crm-extensibility/execution/internal/v3', expect.any(Function));
            expect(devServer.AppProxyService).toHaveBeenCalledTimes(0);
        });
        it('should add the AppFunctionExecutionService middleware if is a private app', async () => {
            const devServerState = new DevServerState({
                ...devServerConfig,
                localDevUrlMapping: {
                    'https://inbound.com': 'http://localhost',
                },
            });
            await startDevServer({
                devServerState,
                viteDevServer: createMockViteDevServer(),
            });
            expect(devServer.AppFunctionExecutionService).toHaveBeenCalledTimes(1);
        });
        it('should not add the AppFunctionExecutionService middleware if is a public app', async () => {
            const devServerState = new DevServerState({
                ...devServerConfig,
                appConfig: { isPublicApp: true },
                localDevUrlMapping: {
                    'https://inbound.com': 'http://localhost',
                },
            });
            await startDevServer({
                devServerState,
                viteDevServer: createMockViteDevServer(),
            });
            expect(devServer.AppFunctionExecutionService).not.toHaveBeenCalled();
        });
        it('should return httpServer and shutdown function', async () => {
            const devServerState = new DevServerState(devServerConfig);
            const result = await startDevServer({
                devServerState,
                viteDevServer: createMockViteDevServer(),
            });
            expect(result).toHaveProperty('httpServer');
            expect(result).toHaveProperty('shutdown');
            expect(typeof result.shutdown).toBe('function');
        });
        it('should initialize ExtensionsWebSocket on devServerState', async () => {
            const devServerState = new DevServerState(devServerConfig);
            await startDevServer({
                devServerState,
                viteDevServer: createMockViteDevServer(),
            });
            expect(devServerState.extensionsWebSocket).toBeDefined();
        });
        it('should trigger WebSocket setup after initialization', async () => {
            const triggerSpy = vi.spyOn(DevServerState.prototype, 'triggerWebSocketSetup');
            const devServerState = new DevServerState(devServerConfig);
            await startDevServer({
                devServerState,
                viteDevServer: createMockViteDevServer(),
            });
            expect(triggerSpy).toHaveBeenCalledTimes(1);
            triggerSpy.mockRestore();
        });
    });
});
