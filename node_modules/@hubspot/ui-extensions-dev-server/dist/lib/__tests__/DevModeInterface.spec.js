import { describe, it, expect, vi, beforeEach, afterEach, } from 'vitest';
import DevModeInterface from "../DevModeInterface.js";
import { DevModeParentInterface } from "../DevModeParentInterface.js";
import * as config from "../config.js";
import { appComponent, appComponentTwoCards, appConfig, cardConfig, cardConfigTwo, } from "./fixtures/extensionConfig.js";
import inquirer from 'inquirer';
import { urls } from "./fixtures/urls.js";
vi.mock('../config.ts', async () => {
    const actual = await vi.importActual('../config.ts');
    return {
        ...actual,
        loadExtensionConfig: vi.fn(),
    };
});
vi.mock('inquirer', () => ({
    default: {
        createPromptModule: vi.fn(),
    },
}));
describe('DevModeInterface', () => {
    describe('setup', () => {
        let parentSetupSpy;
        let mockPromptModule;
        let setActiveApp;
        let logger;
        const cardKey = `${appConfig.uid}::${cardConfig.data.uid}`;
        const components = {
            'my application': appComponent,
        };
        const expectedConfig = {
            ...cardConfig,
            appConfig,
        };
        beforeEach(() => {
            DevModeInterface._reset();
            logger = {
                info: vi.fn(),
                debug: vi.fn(),
                warn: vi.fn(),
                error: vi.fn(),
            };
            DevModeInterface.logger = logger;
            mockPromptModule = vi.fn().mockResolvedValue({
                extensions: [{ ...cardConfig, appConfig }],
            });
            vi.mocked(inquirer.createPromptModule).mockReturnValue(mockPromptModule);
            setActiveApp = vi.fn(() => {
                return Promise.resolve();
            });
            parentSetupSpy = vi.spyOn(DevModeParentInterface.prototype, 'parentSetup');
            vi.mocked(config.loadExtensionConfig).mockReturnValue({
                [cardKey]: cardConfig,
            });
        });
        afterEach(() => {
            vi.clearAllMocks();
        });
        it('should throw an error if no extensions are parsed from the provided components', async () => {
            const components = {
                'not a valid application': {
                    config: {
                        name: 'I do not have an extensions object',
                    },
                    path: '/path/to/my/application',
                },
            };
            await expect(DevModeInterface.setup({
                // @ts-expect-error - Trying to trigger an error with missing fields
                components,
                logger,
                setActiveApp,
                urls,
            })).rejects.toThrowError('No extensions to run');
        });
        it('should directly set configs when there is only one choice', async () => {
            await DevModeInterface.setup({
                components,
                logger,
                setActiveApp,
                urls,
            });
            expect(parentSetupSpy).toHaveBeenCalledWith({
                choices: [
                    {
                        name: 'my application/Meme Card',
                        value: expectedConfig,
                    },
                ],
                components,
                logger,
                setActiveApp,
                urls,
            });
            expect(DevModeInterface.configs).toStrictEqual([expectedConfig]);
        });
        it('should prompt the user when there is more than once choice', async () => {
            const twoCardComponents = {
                'my application': appComponentTwoCards,
            };
            const cardKeyTwo = `${appConfig.uid}::${cardConfigTwo.data.uid}`;
            vi.mocked(config.loadExtensionConfig).mockReturnValue({
                [cardKey]: cardConfig,
                [cardKeyTwo]: cardConfigTwo,
            });
            await DevModeInterface.setup({
                components: twoCardComponents,
                logger,
                setActiveApp,
                urls,
            });
            expect(parentSetupSpy).toHaveBeenCalledWith({
                choices: [
                    {
                        name: 'my application/Meme Card',
                        value: expectedConfig,
                    },
                    {
                        name: 'my application/Another Meme Card',
                        value: {
                            ...cardConfigTwo,
                            appConfig,
                        },
                    },
                ],
                components: twoCardComponents,
                logger,
                setActiveApp,
                urls,
            });
            expect(mockPromptModule).toHaveBeenCalledTimes(1);
            expect(DevModeInterface.configs).toStrictEqual([expectedConfig]);
        });
        it('should call setActiveApp with the correct arg', async () => {
            await DevModeInterface.setup({
                components,
                logger,
                setActiveApp,
                urls,
            });
            expect(setActiveApp).toHaveBeenCalledTimes(1);
            expect(setActiveApp).toHaveBeenCalledWith(appConfig.uid);
        });
        it('should not run setup if it has already been configured', async () => {
            DevModeInterface.isConfigured = true;
            await DevModeInterface.setup({
                components,
                logger,
                setActiveApp,
                urls,
            });
            expect(logger.debug).toHaveBeenCalledWith('Dev server has already been configured, skipping');
            expect(DevModeInterface.configs).toBeUndefined();
        });
    });
});
