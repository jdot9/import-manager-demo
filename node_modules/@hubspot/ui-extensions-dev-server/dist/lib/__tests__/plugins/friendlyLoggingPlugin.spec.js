import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import friendlyLoggingPlugin from "../../plugins/friendlyLoggingPlugin.js";
describe('friendlyLoggingPlugin', () => {
    let plugin;
    let logger;
    beforeEach(() => {
        logger = {
            info: vi.fn(),
            error: vi.fn(),
            debug: vi.fn(),
            warn: vi.fn(),
        };
        plugin = friendlyLoggingPlugin({ logger });
    });
    afterEach(() => {
        vi.clearAllMocks();
    });
    describe('metadata', () => {
        it('should create the correct plugin metadata', () => {
            expect(plugin).toStrictEqual(expect.objectContaining({
                name: 'ui-extensions-friendly-logging-plugin',
                enforce: 'post',
                onLog: expect.any(Function),
            }));
        });
    });
    describe('onLog', () => {
        it('should return true if it is a log message we do not want altered', () => {
            // @ts-expect-error TS doesn't think lifecycle hooks are functions
            const result = plugin.onLog('error', {
                code: "it's an older code but it checks out",
            });
            expect(result).toBe(true);
        });
        it('should return false if it is a log message we want to transform', () => {
            // @ts-expect-error TS doesn't think lifecycle hooks are functions
            const result = plugin.onLog('error', {
                code: 'MISSING_GLOBAL_NAME',
            });
            expect(result).toBe(false);
        });
        it('should not log MISSING_GLOBAL_NAME errors', () => {
            // @ts-expect-error TS doesn't think lifecycle hooks are functions
            const result = plugin.onLog('error', {
                code: 'MISSING_GLOBAL_NAME',
            });
            expect(result).toBe(false);
            expect(logger.error).toHaveBeenCalledTimes(0);
            expect(logger.info).toHaveBeenCalledTimes(0);
            expect(logger.debug).toHaveBeenCalledTimes(0);
            expect(logger.warn).toHaveBeenCalledTimes(0);
        });
        it('should call the logger correctly for UNRESOLVED_IMPORT errors', () => {
            // @ts-expect-error TS doesn't think lifecycle hooks are functions
            const result = plugin.onLog('we ignore this for now', {
                code: 'UNRESOLVED_IMPORT',
                id: 'the/file/that/imported/the/bad/import.jsx',
                exporter: '@hubspot/extensions',
            });
            expect(result).toBe(false);
            expect(logger.error).toHaveBeenCalledTimes(1);
            expect(logger.error).toHaveBeenCalledWith('@hubspot/extensions is imported by import.jsx, but @hubspot/extensions cannot be resolved. Make sure @hubspot/extensions is installed.');
        });
    });
});
