import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
vi.mock('fs');
import codeCheckingPlugin from "../../plugins/codeCheckingPlugin.js";
import fs from 'fs';
describe('codeCheckingPlugin', () => {
    let options;
    let plugin;
    let logger;
    beforeEach(() => {
        logger = {
            info: vi.fn(),
            error: vi.fn(),
            debug: vi.fn(),
            warn: vi.fn(),
        };
        options = {
            output: 'test.jsx',
            logger,
        };
        plugin = codeCheckingPlugin(options);
    });
    afterEach(() => {
        vi.clearAllMocks();
    });
    describe('metadata', () => {
        it('should create the correct plugin metadata', () => {
            expect(plugin).toStrictEqual(expect.objectContaining({
                name: 'ui-extensions-code-checking-plugin',
                enforce: 'post',
                writeBundle: expect.any(Function),
            }));
        });
    });
    describe('writeBundle', () => {
        it('should log a warning if the expected code is not found', () => {
            // @ts-expect-error Mock
            fs.readFileSync = vi.fn(() => {
                return `not the code we want, not hubspot extend call in here`;
            });
            // @ts-expect-error TS thinks these aren't functions
            plugin.writeBundle('', '');
            expect(logger.warn).toHaveBeenCalledTimes(1);
            expect(logger.warn).toHaveBeenCalledWith('Unable to determine if your extension entry point is calling hubspot.extend, this may prevent it from rendering as expected');
        });
        it('should not log a warning if the old extend method is found', () => {
            // @ts-expect-error Mock
            fs.readFileSync = vi.fn(() => {
                return `someFunction();const extend = (...args) => self.extend(...args);someOtherFunc()`;
            });
            // @ts-expect-error TS thinks these aren't functions
            plugin.writeBundle('', '');
            expect(logger.warn).not.toHaveBeenCalled();
        });
        it('should not log a warning if the new extend method is found', () => {
            // @ts-expect-error Mock
            fs.readFileSync = vi.fn(() => {
                return `someFunction();self.extend_V2(renderExtensionCallback);someOtherFunc()`;
            });
            // @ts-expect-error TS thinks these aren't functions
            plugin.writeBundle('', '');
            expect(logger.warn).not.toHaveBeenCalled();
        });
        it('should not log a warning if the v0.11.3+ extend method implementation is found', () => {
            // @ts-expect-error Mock
            fs.readFileSync = vi.fn(() => {
                return `someFunction();const extend_V2 = getWorkerGlobals().extend_V2;someOtherFunc()`;
            });
            // @ts-expect-error TS thinks these aren't functions
            plugin.writeBundle('', '');
            expect(logger.warn).not.toHaveBeenCalled();
        });
        it('should log an error if we are unable to load the code', () => {
            fs.readFileSync = vi.fn(() => {
                throw new Error('OH NO');
            });
            // @ts-expect-error TS thinks these aren't functions
            plugin.writeBundle('', '');
            expect(logger.error).toHaveBeenCalledTimes(1);
            expect(logger.error).toHaveBeenCalledWith('Unable to load bundle for code checking');
        });
    });
});
