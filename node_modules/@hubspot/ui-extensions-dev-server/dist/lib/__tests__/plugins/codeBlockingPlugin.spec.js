import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
vi.mock('../../ast', () => ({
    traverseAbstractSyntaxTree: vi.fn((input) => {
        if (input === 'invalid') {
            return {
                functions: {
                    require: {
                        invoked: true,
                        scope: 'Global',
                    },
                },
            };
        }
        if (input === 'outOfBounds') {
            return {
                functions: {},
                badImports: ['/outside/path/file'],
            };
        }
        return {
            functions: {
                require: {
                    invoked: true,
                    defined: true,
                    scope: 'Local',
                },
            },
        };
    }),
}));
import codeBlockingPlugin from "../../plugins/codeBlockingPlugin.js";
import { traverseAbstractSyntaxTree } from "../../ast.js";
describe('codeBlockingPlugin', () => {
    let plugin;
    let logger;
    const extensionPath = '/mock/extension/path';
    beforeEach(() => {
        logger = {
            info: vi.fn(),
            error: vi.fn(),
            debug: vi.fn(),
            warn: vi.fn(),
        };
        plugin = codeBlockingPlugin({ logger, extensionPath });
    });
    afterEach(() => {
        vi.clearAllMocks();
    });
    describe('metadata', () => {
        it('should create the correct plugin metadata', () => {
            expect(plugin).toStrictEqual(expect.objectContaining({
                name: 'ui-extensions-code-blocking-plugin',
                transform: expect.any(Function),
            }));
        });
    });
    describe('transform', () => {
        it('should log a warning when require is being invoked', () => {
            const code = 'invalid';
            // @ts-expect-error It does exist, I promise
            plugin.parse = vi.fn((input) => {
                return input;
            });
            // @ts-expect-error Deep breath TS, it's ok
            plugin.transform(code, 'filename');
            expect(logger.warn).toHaveBeenCalledWith('require statements are not supported, replace require statements with import');
            // @ts-expect-error It does exist, I promise
            expect(plugin.parse).toBeCalledTimes(1);
            // @ts-expect-error It does exist, I promise
            expect(plugin.parse).toBeCalledWith(code);
            expect(traverseAbstractSyntaxTree).toHaveBeenCalledTimes(1);
        });
        it('should log a warning when an out of bounds import is detected', () => {
            const code = 'outOfBounds';
            // @ts-expect-error It does exist, I promise
            plugin.parse = vi.fn((input) => {
                return input;
            });
            // @ts-expect-error Deep breath TS, it's ok
            plugin.transform(code, 'filename');
            expect(logger.warn).toHaveBeenCalledWith('Importing files from outside of the extension directory is not supported. Please move the import /outside/path/file into the extension directory.');
            // @ts-expect-error It does exist, I promise
            expect(plugin.parse).toBeCalledTimes(1);
            expect(traverseAbstractSyntaxTree).toHaveBeenCalledTimes(1);
        });
        it('should not parse node_modules', () => {
            // @ts-expect-error It does exist, I promise
            plugin.parse = vi.fn(() => {
                return {};
            });
            // @ts-expect-error Deep breath TS, it's ok
            plugin.transform('valid', 'node_modules/filename');
            // @ts-expect-error It does exist, I promise
            expect(plugin.parse).not.toHaveBeenCalled();
        });
        it('should not throw an error for valid code', () => {
            const code = 'valid';
            // @ts-expect-error It does exist, I promise
            plugin.parse = vi.fn(() => {
                return {};
            });
            // @ts-expect-error Deep breath TS, it's ok
            const result = plugin.transform(code, 'filename');
            // @ts-expect-error It does exist, I promise
            expect(plugin.parse).toBeCalledTimes(1);
            // @ts-expect-error It does exist, I promise
            expect(plugin.parse).toBeCalledWith(code);
            expect(traverseAbstractSyntaxTree).toHaveBeenCalledTimes(1);
            expect(result.code).toBe(code);
        });
    });
});
