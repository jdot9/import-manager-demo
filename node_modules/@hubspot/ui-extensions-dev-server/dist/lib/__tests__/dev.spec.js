import { describe, it, expect, vi, beforeEach } from 'vitest';
import { startDevMode } from "../dev.js";
import { createServer } from 'vite';
import startDevServer from "../server.js";
import { DevServerState } from "../DevServerState.js";
import { createMockLogger, createDevServerConfig } from "./factories.js";
vi.mock('vite', () => ({
    createServer: vi.fn(() => ({
        name: 'vite-dev-server',
    })),
}));
vi.mock('../server', () => ({
    default: vi.fn(() => ({
        httpServer: {},
        shutdown: vi.fn(),
    })),
}));
vi.mock('detect-port', () => ({
    default: vi.fn((port) => {
        if (port === 7890) {
            return 1235; // Simulate port unavailable
        }
        return port;
    }),
}));
describe('dev', () => {
    let devServerState;
    let logger;
    beforeEach(() => {
        vi.clearAllMocks();
        logger = createMockLogger();
        devServerState = new DevServerState(createDevServerConfig(logger));
    });
    describe('startDevMode', () => {
        it('should throw an error if extensionConfig is undefined', async () => {
            // @ts-expect-error Causing an error on purpose
            await expect(startDevMode(undefined)).rejects.toThrow(/^Unable to determine which extension to run/);
        });
        it('should throw an error if the express port is in use', async () => {
            const badPort = new DevServerState(createDevServerConfig(logger, { expressPort: 7890 }));
            await expect(startDevMode(badPort)).rejects.toThrow(/^Unable to start because port 7890 is already in use/);
        });
        it('should call vite createServer', async () => {
            await startDevMode(devServerState);
            expect(createServer).toHaveBeenCalledTimes(1);
            expect(createServer).toHaveBeenCalledWith(expect.objectContaining({
                appType: 'custom',
                mode: 'development',
                server: expect.objectContaining({
                    middlewareMode: true,
                    hmr: expect.objectContaining({
                        server: null,
                    }),
                    cors: expect.objectContaining({
                        credentials: true,
                    }),
                    watch: {
                        ignored: [
                            `${devServerState.outputDir}/**/*`,
                            '**/src/app/app.functions/**/*',
                            '**/app.json',
                            '**/package.json',
                            '**/package-lock.json',
                        ],
                    },
                }),
                clearScreen: false,
                logLevel: 'silent',
            }));
        });
        it('should call startDevServer', async () => {
            await startDevMode(devServerState);
            expect(startDevServer).toHaveBeenCalledTimes(1);
            expect(startDevServer).toHaveBeenCalledWith({
                devServerState,
                viteDevServer: { name: 'vite-dev-server' },
            });
        });
    });
});
