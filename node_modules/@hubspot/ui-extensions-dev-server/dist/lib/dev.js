import { createServer } from 'vite';
import path from 'path';
import startDevServer from "./server.js";
import devBuildPlugin from "./plugins/devBuildPlugin.js";
import { ALLOWED_ORIGIN_PATTERNS } from "./ExtensionsWebSocket.js";
import detect from 'detect-port';
async function _createViteDevServer(devServerState) {
    return await createServer({
        root: devServerState.appPath,
        logLevel: 'silent',
        appType: 'custom',
        mode: 'development',
        server: {
            middlewareMode: true,
            hmr: {
                server: null, // We use our own WebSocket server (ExtensionsWebSocket) instead of Vite's
            },
            cors: {
                origin: ALLOWED_ORIGIN_PATTERNS,
                credentials: true,
            },
            watch: {
                ignored: [
                    path.join(devServerState.outputDir, '/**/*'),
                    '**/src/app/app.functions/**/*',
                    '**/app.json',
                    '**/package.json',
                    '**/package-lock.json',
                ],
            },
        },
        plugins: [
            devBuildPlugin({
                devServerState,
            }),
        ],
        clearScreen: false,
    });
}
async function throwIfPortTaken(port) {
    // detect takes a port and returns the next available port
    // so a mismatch means the requested port was not available
    if ((await detect(port)) !== port) {
        throw new Error(`Unable to start because port ${port} is already in use`);
    }
}
export async function startDevMode(devServerState) {
    if (!devServerState || !devServerState.extensionsMetadata) {
        throw new Error('Unable to determine which extension to run');
    }
    await throwIfPortTaken(devServerState.expressPort);
    const viteDevServer = await _createViteDevServer(devServerState);
    const { shutdown } = await startDevServer({
        devServerState,
        viteDevServer,
    });
    return shutdown;
}
