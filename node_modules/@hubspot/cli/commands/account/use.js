import { getConfigFilePath, setConfigAccountAsDefault, getConfigAccountIfExists, getConfigAccountByName, getConfigAccountById, } from '@hubspot/local-dev-lib/config';
import { getDefaultAccountOverrideAccountId, getDefaultAccountOverrideFilePath, } from '@hubspot/local-dev-lib/config/defaultAccountOverride';
import { trackCommandUsage } from '../../lib/usageTracking.js';
import { commands } from '../../lang/en.js';
import { uiLogger } from '../../lib/ui/logger.js';
import { selectAccountFromConfig } from '../../lib/prompts/accountsPrompt.js';
import { makeYargsBuilder } from '../../lib/yargsUtils.js';
const command = 'use [account]';
const describe = commands.account.subcommands.use.describe;
async function handler(args) {
    let newDefaultAccount = args.account;
    if (!newDefaultAccount) {
        newDefaultAccount = await selectAccountFromConfig();
    }
    else {
        const account = getConfigAccountIfExists(newDefaultAccount);
        if (!account) {
            uiLogger.error(commands.account.subcommands.use.errors.accountNotFound(newDefaultAccount, getConfigFilePath()));
            newDefaultAccount = await selectAccountFromConfig();
        }
    }
    let account;
    if (!isNaN(Number(newDefaultAccount))) {
        account = getConfigAccountById(Number(newDefaultAccount));
    }
    else {
        account = getConfigAccountByName(String(newDefaultAccount));
    }
    trackCommandUsage('accounts-use', undefined, account?.accountId);
    const accountOverride = getDefaultAccountOverrideAccountId();
    const overrideFilePath = getDefaultAccountOverrideFilePath();
    if (accountOverride && overrideFilePath) {
        uiLogger.warn(commands.account.subcommands.use.accountOverride(accountOverride.toString()));
        uiLogger.log(commands.account.subcommands.use.accountOverrideCommands);
        uiLogger.log('');
    }
    setConfigAccountAsDefault(newDefaultAccount);
    return uiLogger.success(commands.account.subcommands.use.success.defaultAccountUpdated(account.name));
}
function accountUseBuilder(yargs) {
    yargs.positional('account', {
        describe: commands.account.subcommands.use.options.account.describe,
        type: 'string',
    });
    yargs.example([
        ['$0 accounts use', commands.account.subcommands.use.examples.default],
        [
            '$0 accounts use MyAccount',
            commands.account.subcommands.use.examples.nameBased,
        ],
        [
            '$0 accounts use 1234567',
            commands.account.subcommands.use.examples.idBased,
        ],
    ]);
    return yargs;
}
const builder = makeYargsBuilder(accountUseBuilder, command, describe, {
    useGlobalOptions: true,
});
const accountUseCommand = {
    command,
    describe,
    handler,
    builder,
};
export default accountUseCommand;
