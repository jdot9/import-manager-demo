import yargs from 'yargs';
import { addConfigOptions, addAccountOptions, } from '../../../lib/commonOpts.js';
import accountRenameCommand from '../rename.js';
import * as config from '@hubspot/local-dev-lib/config';
import { logError } from '../../../lib/errorHandlers/index.js';
import { EXIT_CODES } from '../../../lib/enums/exitCodes.js';
import * as usageTracking from '../../../lib/usageTracking.js';
vi.mock('../../../lib/commonOpts');
vi.mock('@hubspot/local-dev-lib/config');
vi.mock('../../../lib/errorHandlers/index.js');
vi.mock('../../../lib/usageTracking.js');
const positionalSpy = vi
    .spyOn(yargs, 'positional')
    .mockReturnValue(yargs);
const exampleSpy = vi
    .spyOn(yargs, 'example')
    .mockReturnValue(yargs);
const renameAccountSpy = vi.spyOn(config, 'renameConfigAccount');
const processExitSpy = vi.spyOn(process, 'exit');
const trackCommandUsageSpy = vi.spyOn(usageTracking, 'trackCommandUsage');
describe('commands/account/rename', () => {
    const yargsMock = yargs;
    describe('command', () => {
        it('should have the correct command structure', () => {
            expect(accountRenameCommand.command).toEqual('rename <account-name> <new-name>');
        });
    });
    describe('describe', () => {
        it('should provide a description', () => {
            expect(accountRenameCommand.describe).toBeDefined();
        });
    });
    describe('handler', () => {
        let args;
        beforeEach(() => {
            vi.clearAllMocks();
            renameAccountSpy.mockReturnValue(undefined);
            processExitSpy.mockImplementation(() => {
                throw new Error('process.exit called');
            });
            args = {
                accountName: 'myExistingAccountName',
                newName: 'myNewAccountName',
            };
        });
        it('should rename the account', async () => {
            await expect(accountRenameCommand.handler(args)).rejects.toThrow('process.exit called');
            expect(trackCommandUsageSpy).toHaveBeenCalledWith('accounts-rename', undefined, undefined);
            expect(renameAccountSpy).toHaveBeenCalledWith('myExistingAccountName', 'my-new-account-name');
            expect(processExitSpy).toHaveBeenCalledWith(EXIT_CODES.SUCCESS);
        });
        it('should handle errors when renameAccount throws', async () => {
            const error = new Error('Failed to rename account');
            renameAccountSpy.mockImplementation(() => {
                throw error;
            });
            await expect(accountRenameCommand.handler(args)).rejects.toThrow('process.exit called');
            expect(trackCommandUsageSpy).toHaveBeenCalledWith('accounts-rename', undefined, undefined);
            expect(renameAccountSpy).toHaveBeenCalledWith('myExistingAccountName', 'my-new-account-name');
            expect(logError).toHaveBeenCalledTimes(1);
            expect(logError).toHaveBeenCalledWith(error);
            expect(processExitSpy).toHaveBeenCalledWith(EXIT_CODES.ERROR);
        });
    });
    describe('builder', () => {
        it('should support the correct options', () => {
            accountRenameCommand.builder(yargsMock);
            expect(exampleSpy).toHaveBeenCalledTimes(1);
            expect(positionalSpy).toHaveBeenCalledTimes(2);
            expect(positionalSpy).toHaveBeenCalledWith('account-name', {
                describe: expect.any(String),
                type: 'string',
            });
            expect(positionalSpy).toHaveBeenCalledWith('new-name', {
                describe: expect.any(String),
                type: 'string',
            });
            expect(addConfigOptions).toHaveBeenCalledTimes(1);
            expect(addConfigOptions).toHaveBeenCalledWith(yargsMock);
            expect(addAccountOptions).toHaveBeenCalledTimes(1);
            expect(addAccountOptions).toHaveBeenCalledWith(yargsMock);
        });
    });
});
