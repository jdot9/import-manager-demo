import { fetchDeveloperTestAccounts, deleteDeveloperTestAccount, } from '@hubspot/local-dev-lib/api/developerTestAccounts';
import { makeYargsBuilder } from '../../lib/yargsUtils.js';
import { EXIT_CODES } from '../../lib/enums/exitCodes.js';
import { uiLogger } from '../../lib/ui/logger.js';
import { trackCommandUsage } from '../../lib/usageTracking.js';
import { commands } from '../../lang/en.js';
import { removeAccountFromConfig, getConfigAccountById, getConfigAccountIfExists, setConfigAccountAsDefault, getConfigDefaultAccountIfExists, } from '@hubspot/local-dev-lib/config';
import { promptUser } from '../../lib/prompts/promptUtils.js';
import { debugError } from '../../lib/errorHandlers/index.js';
const command = 'delete [test-account]';
const describe = commands.testAccount.delete.describe;
async function getAccountPromptOptions(derivedAccountId) {
    try {
        const { data } = await fetchDeveloperTestAccounts(derivedAccountId);
        return data.results.map(testAccount => ({
            name: `${testAccount.accountName} (${testAccount.id})`,
            value: testAccount.id,
        }));
    }
    catch (err) {
        uiLogger.error(commands.testAccount.delete.errors.failedToFetchTestAccounts);
        throw err;
    }
}
async function accountToDeleteSelectionPrompt(derivedAccountId) {
    const accountData = await getAccountPromptOptions(derivedAccountId);
    if (accountData.length === 0) {
        uiLogger.error(commands.testAccount.delete.errors.noAccountsToDelete(derivedAccountId));
        process.exit(EXIT_CODES.ERROR);
    }
    const { testAccountToDelete } = await promptUser([
        {
            type: 'list',
            name: 'testAccountToDelete',
            pageSize: 20,
            message: commands.testAccount.delete.prompts.selectTestAccounts,
            choices: accountData,
        },
    ]);
    return testAccountToDelete;
}
async function confirmDeletion() {
    const { shouldDelete } = await promptUser([
        {
            type: 'confirm',
            name: 'shouldDelete',
            message: commands.testAccount.delete.prompts.confirmDeletion,
        },
    ]);
    return shouldDelete;
}
async function deleteTestAccountInHubSpot(derivedAccountId, accountId) {
    try {
        await deleteDeveloperTestAccount(derivedAccountId, accountId, true);
        uiLogger.success(commands.testAccount.delete.success.testAccountDeletedFromHubSpot(accountId));
    }
    catch (e) {
        debugError(e);
        uiLogger.error(commands.testAccount.delete.errors.failedToDelete(accountId));
    }
}
async function deleteTestAccountFromConfig(testAccountId, parentAccountName, account) {
    try {
        // If the account isn't in the local config then it wasn't auth'd on the local machine
        if (account && account.name && account.accountType) {
            // If the deleted test account was the default account, replace the default account with the parent account
            const defaultAccount = getConfigDefaultAccountIfExists();
            const defaultAccountId = defaultAccount?.accountId;
            removeAccountFromConfig(account.accountId);
            uiLogger.success(commands.testAccount.delete.success.testAccountDeletedFromConfig(testAccountId));
            if (testAccountId === defaultAccountId) {
                setConfigAccountAsDefault(parentAccountName);
                uiLogger.info(commands.testAccount.delete.info.replaceDefaultAccount(testAccountId, parentAccountName));
            }
        }
    }
    catch (e) {
        debugError(e);
        uiLogger.error(commands.testAccount.delete.errors.failedToDeleteFromConfig(testAccountId));
    }
}
async function validateTestAccountConfigs(testAccountId) {
    if (!testAccountId) {
        uiLogger.error(commands.testAccount.delete.errors.testAccountNotFound(testAccountId));
        process.exit(EXIT_CODES.ERROR);
    }
    const testAccountConfig = getConfigAccountById(testAccountId);
    if (!testAccountConfig) {
        uiLogger.error(commands.testAccount.delete.errors.testAccountNotFound(testAccountId));
        process.exit(EXIT_CODES.ERROR);
    }
    const parentAccountConfig = getConfigAccountById(testAccountConfig.parentAccountId);
    if (!parentAccountConfig) {
        uiLogger.error(commands.testAccount.delete.errors.parentAccountNotFound(testAccountId));
        process.exit(EXIT_CODES.ERROR);
    }
    const parentAccountName = parentAccountConfig.name;
    return { testAccountConfig, parentAccountName };
}
async function handler(args) {
    const { derivedAccountId, testAccount, force } = args;
    trackCommandUsage('test-account-delete', {}, derivedAccountId);
    let testAccountIdToDelete = 0;
    // See if the account exists
    if (testAccount) {
        const account = getConfigAccountIfExists(testAccount);
        const accountId = account?.accountId || null;
        await validateTestAccountConfigs(accountId);
        if (accountId) {
            testAccountIdToDelete = accountId;
        }
    }
    // Prompt for selection when name or id aren't provided
    if (!testAccountIdToDelete) {
        try {
            testAccountIdToDelete =
                await accountToDeleteSelectionPrompt(derivedAccountId);
        }
        catch (err) {
            debugError(err);
            uiLogger.error(commands.testAccount.delete.errors.failedToSelectAccount);
            process.exit(EXIT_CODES.ERROR);
        }
    }
    const { testAccountConfig, parentAccountName } = await validateTestAccountConfigs(testAccountIdToDelete);
    // If --force, don't prompt user; else confirm deletion
    let shouldDeleteAccount;
    if (force) {
        shouldDeleteAccount = true;
    }
    else {
        shouldDeleteAccount = await confirmDeletion();
    }
    if (shouldDeleteAccount) {
        const parentAccountId = testAccountConfig.parentAccountId;
        await deleteTestAccountInHubSpot(parentAccountId, testAccountIdToDelete);
        await deleteTestAccountFromConfig(testAccountIdToDelete, parentAccountName, testAccountConfig);
    }
    else {
        uiLogger.info(commands.testAccount.delete.info.deletionCanceled);
    }
    process.exit(EXIT_CODES.SUCCESS);
}
function deleteTestAccountBuilder(yargs) {
    yargs.positional('test-account', {
        type: 'string',
        description: commands.testAccount.delete.options.id,
        required: false,
    });
    yargs.option('force', {
        describe: commands.testAccount.delete.options.force,
        type: 'boolean',
        default: false,
    });
    yargs.example([
        [
            '$0 test-account delete 12345678',
            commands.testAccount.delete.examples.withPositionalID(12345678),
        ],
        [
            '$0 test-account delete my-test-account',
            commands.testAccount.delete.examples.withPositionalName('my-test-account'),
        ],
        [
            '$0 test-account delete --test-account=12345678',
            commands.testAccount.delete.examples.withID(12345678),
        ],
        [
            '$0 test-account delete --test-account=my-test-account',
            commands.testAccount.delete.examples.withName('my-test-account'),
        ],
        ['$0 test-account delete', commands.testAccount.delete.examples.withoutId],
    ]);
    return yargs;
}
const builder = makeYargsBuilder(deleteTestAccountBuilder, command, describe, {
    useGlobalOptions: true,
    useEnvironmentOptions: true,
    useConfigOptions: true,
    useTestingOptions: true,
});
const deleteTestAccountCommand = {
    command,
    describe,
    handler,
    builder,
};
export default deleteTestAccountCommand;
