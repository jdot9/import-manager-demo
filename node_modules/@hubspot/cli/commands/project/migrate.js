import { migrateApp2025_2 } from '../../lib/app/migrate.js';
import { getProjectConfig } from '../../lib/projects/config.js';
import { PLATFORM_VERSIONS } from '@hubspot/local-dev-lib/constants/projects';
import { logError } from '../../lib/errorHandlers/index.js';
import { EXIT_CODES } from '../../lib/enums/exitCodes.js';
import { makeYargsBuilder } from '../../lib/yargsUtils.js';
import { uiCommandReference } from '../../lib/ui/index.js';
import { commands, lib } from '../../lang/en.js';
import { uiLogger } from '../../lib/ui/logger.js';
import { renderInline } from '../../ui/index.js';
import { getWarningBox } from '../../ui/components/StatusMessageBoxes.js';
import { getHasMigratableThemes, migrateThemes2025_2, } from '../../lib/theme/migrate.js';
import { hasFeature } from '../../lib/hasFeature.js';
import { FEATURES } from '../../lib/constants.js';
import { trackCommandMetadataUsage, trackCommandUsage, } from '../../lib/usageTracking.js';
const { v2025_2 } = PLATFORM_VERSIONS;
const command = 'migrate';
const describe = commands.project.migrate.describe;
async function handler(args) {
    const { platformVersion, unstable, derivedAccountId } = args;
    await trackCommandUsage('project-migrate', {}, derivedAccountId);
    const projectConfig = await getProjectConfig();
    if (!projectConfig.projectConfig) {
        uiLogger.error(commands.project.migrate.errors.noProjectConfig(uiCommandReference('hs app migrate')));
        return process.exit(EXIT_CODES.ERROR);
    }
    if (projectConfig?.projectConfig) {
        await renderInline(getWarningBox({
            title: lib.migrate.projectMigrationWarningTitle,
            message: lib.migrate.projectMigrationWarning,
        }));
    }
    try {
        const { hasMigratableThemes, migratableThemesCount } = await getHasMigratableThemes(projectConfig);
        if (hasMigratableThemes) {
            const hasThemeMigrationAccess = await hasFeature(derivedAccountId, FEATURES.THEME_MIGRATION_2025_2);
            if (!hasThemeMigrationAccess) {
                uiLogger.error(commands.project.migrate.errors.noThemeMigrationAccess(derivedAccountId));
                return process.exit(EXIT_CODES.ERROR);
            }
            await migrateThemes2025_2(derivedAccountId, {
                ...args,
                platformVersion: unstable
                    ? PLATFORM_VERSIONS.unstable
                    : platformVersion,
            }, migratableThemesCount, projectConfig);
        }
        else {
            await migrateApp2025_2(derivedAccountId, {
                ...args,
                name: projectConfig?.projectConfig?.name,
                platformVersion: unstable
                    ? PLATFORM_VERSIONS.unstable
                    : platformVersion,
            }, projectConfig);
        }
    }
    catch (error) {
        await trackCommandMetadataUsage('project-migrate', { successful: false }, derivedAccountId);
        logError(error);
        return process.exit(EXIT_CODES.ERROR);
    }
    await trackCommandMetadataUsage('project-migrate', { successful: true }, derivedAccountId);
    return process.exit(EXIT_CODES.SUCCESS);
}
function projectMigrateBuilder(yargs) {
    yargs
        .option('platform-version', {
        type: 'string',
        choices: [v2025_2],
        default: v2025_2,
    })
        .option('unstable', {
        type: 'boolean',
        default: false,
        hidden: true,
    });
    return yargs;
}
const builder = makeYargsBuilder(projectMigrateBuilder, command, commands.project.migrate.describe, {
    useGlobalOptions: true,
    useConfigOptions: true,
    useAccountOptions: true,
});
const migrateCommand = {
    command,
    describe,
    handler,
    builder,
};
export default migrateCommand;
