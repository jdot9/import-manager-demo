import { Separator } from '@inquirer/prompts';
import { lib } from '../../lang/en.js';
import { promptUser } from './promptUtils.js';
const hubs = {
    MARKETING: 'marketingLevel',
    OPS: 'opsLevel',
    SERVICE: 'serviceLevel',
    SALES: 'salesLevel',
    CONTENT: 'contentLevel',
};
const AccountTiers = {
    FREE: 'FREE',
    STARTER: 'STARTER',
    PROFESSIONAL: 'PROFESSIONAL',
    ENTERPRISE: 'ENTERPRISE',
};
const makeHubTiers = (hubKey) => {
    const hubTypeKey = hubKey.toLowerCase();
    const hubName = lib.prompts.createDeveloperTestAccountConfigPrompt.hubTypes[hubTypeKey];
    return [
        {
            name: `${hubName} [${AccountTiers.FREE}]`,
            value: { hub: hubKey, tier: AccountTiers.FREE },
        },
        {
            name: `${hubName} [${AccountTiers.STARTER}]`,
            value: { hub: hubKey, tier: AccountTiers.STARTER },
        },
        {
            name: `${hubName} [${AccountTiers.PROFESSIONAL}]`,
            value: { hub: hubKey, tier: AccountTiers.PROFESSIONAL },
        },
        {
            name: `${hubName} [${AccountTiers.ENTERPRISE}]`,
            value: { hub: hubKey, tier: AccountTiers.ENTERPRISE },
        },
    ];
};
const TEST_ACCOUNT_TIERS = [
    ...makeHubTiers('MARKETING'),
    new Separator(),
    ...makeHubTiers('OPS'),
    new Separator(),
    ...makeHubTiers('SERVICE'),
    new Separator(),
    ...makeHubTiers('SALES'),
    new Separator(),
    ...makeHubTiers('CONTENT'),
    new Separator(),
];
export async function createDeveloperTestAccountConfigPrompt(args = {}, supportFlags = true) {
    const hasAnyTierLevels = !!(args.marketingLevel ||
        args.opsLevel ||
        args.serviceLevel ||
        args.salesLevel ||
        args.contentLevel);
    const result = await promptUser([
        {
            name: 'accountName',
            message: lib.prompts.createDeveloperTestAccountConfigPrompt.namePrompt(supportFlags),
            type: 'input',
            when: !args.name,
            validate: value => {
                if (!value) {
                    return lib.prompts.createDeveloperTestAccountConfigPrompt.errors
                        .nameRequired;
                }
                return true;
            },
        },
        {
            name: 'description',
            message: lib.prompts.createDeveloperTestAccountConfigPrompt.descriptionPrompt(supportFlags),
            type: 'input',
            when: !args.description,
        },
    ]);
    const accountName = args.name || result.accountName;
    const description = args.description || result.description;
    let accountLevels = {};
    if (hasAnyTierLevels) {
        accountLevels = {
            marketingLevel: args.marketingLevel || 'ENTERPRISE',
            opsLevel: args.opsLevel || 'ENTERPRISE',
            serviceLevel: args.serviceLevel || 'ENTERPRISE',
            salesLevel: args.salesLevel || 'ENTERPRISE',
            contentLevel: args.contentLevel || 'ENTERPRISE',
        };
    }
    else {
        const tierChoiceResult = await promptUser({
            name: 'useDefaultAccountLevels',
            message: lib.prompts.createDeveloperTestAccountConfigPrompt
                .useDefaultAccountLevelsPrompt.message,
            type: 'list',
            choices: [
                {
                    name: lib.prompts.createDeveloperTestAccountConfigPrompt
                        .useDefaultAccountLevelsPrompt.default,
                    value: 'default',
                },
                {
                    name: lib.prompts.createDeveloperTestAccountConfigPrompt
                        .useDefaultAccountLevelsPrompt.manual,
                    value: 'manual',
                },
            ],
        });
        if (tierChoiceResult.useDefaultAccountLevels === 'default') {
            accountLevels = {
                marketingLevel: 'ENTERPRISE',
                opsLevel: 'ENTERPRISE',
                serviceLevel: 'ENTERPRISE',
                salesLevel: 'ENTERPRISE',
                contentLevel: 'ENTERPRISE',
            };
        }
        else {
            const tierResult = await promptUser({
                name: 'testAccountLevels',
                message: lib.prompts.createDeveloperTestAccountConfigPrompt.tiersPrompt,
                type: 'checkbox',
                pageSize: 13,
                choices: TEST_ACCOUNT_TIERS,
                loop: false,
                validate: choices => {
                    if (choices?.length < Object.keys(hubs).length) {
                        return lib.prompts.createDeveloperTestAccountConfigPrompt.errors
                            .allHubsRequired;
                    }
                    const hubMap = {};
                    for (const choice of choices) {
                        const { hub } = choice.value;
                        if (hubMap[hub]) {
                            return lib.prompts.createDeveloperTestAccountConfigPrompt.errors
                                .tiersError;
                        }
                        hubMap[hub] = true;
                    }
                    return true;
                },
            });
            accountLevels = tierResult.testAccountLevels.reduce((acc, level) => {
                const { hub: hubName, tier: hubTier } = level;
                const hubLevel = hubs[hubName];
                acc[hubLevel] = hubTier;
                return acc;
            }, {});
        }
    }
    return {
        accountName,
        description,
        ...accountLevels,
    };
}
