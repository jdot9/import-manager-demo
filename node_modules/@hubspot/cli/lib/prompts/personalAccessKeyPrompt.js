import open from 'open';
import { OAUTH_SCOPES, DEFAULT_OAUTH_SCOPES, } from '@hubspot/local-dev-lib/constants/auth';
import { deleteConfigFileIfEmpty } from '@hubspot/local-dev-lib/config';
import { getHubSpotWebsiteOrigin } from '@hubspot/local-dev-lib/urls';
import { uiLogger } from '../ui/logger.js';
import { promptUser } from './promptUtils.js';
import { getCliAccountNamePromptConfig, } from './accountNamePrompt.js';
import { uiInfoSection } from '../ui/index.js';
import { EXIT_CODES } from '../enums/exitCodes.js';
import { lib } from '../../lang/en.js';
/**
 * Displays notification to user that we are about to open the browser,
 * then opens their browser to the personal-access-key shortlink
 */
export async function personalAccessKeyPrompt({ env, account, }) {
    const websiteOrigin = getHubSpotWebsiteOrigin(env);
    let url = `${websiteOrigin}/l/personal-access-key`;
    if (process.env.BROWSER !== 'none') {
        uiInfoSection(lib.prompts.personalAccessKeyPrompt.personalAccessKeySetupTitle, () => {
            uiLogger.log(lib.prompts.personalAccessKeyPrompt.personalAccessKeyBrowserOpenPrep);
        });
        if (account) {
            url = `${websiteOrigin}/personal-access-key/${account}`;
        }
        const { personalAccessKeyBrowserOpenPrep: choice } = await promptUser([
            PERSONAL_ACCESS_KEY_BROWSER_OPEN_PREP,
        ]);
        if (!choice) {
            deleteConfigFileIfEmpty();
            process.exit(EXIT_CODES.SUCCESS);
        }
        if (choice ===
            lib.prompts.personalAccessKeyPrompt.personalAccessKeyPromptChoices
                .OPEN_BROWSER) {
            open(url, { url: true });
            uiLogger.log(lib.prompts.personalAccessKeyPrompt.logs.openingWebBrowser(url));
        }
    }
    const { personalAccessKey } = await promptUser(PERSONAL_ACCESS_KEY);
    return {
        personalAccessKey,
        env,
    };
}
const ACCOUNT_ID = {
    name: 'accountId',
    message: lib.prompts.personalAccessKeyPrompt.enterAccountId,
    type: 'number',
    validate(val) {
        if (!Number.isNaN(val) && val !== undefined && val > 0) {
            return true;
        }
        return lib.prompts.personalAccessKeyPrompt.errors.invalidAccountId;
    },
};
const CLIENT_ID = {
    name: 'clientId',
    message: lib.prompts.personalAccessKeyPrompt.enterClientId,
    validate(val) {
        if (typeof val !== 'string') {
            return lib.prompts.personalAccessKeyPrompt.errors.invalidOauthClientId;
        }
        else if (val.length !== 36) {
            return lib.prompts.personalAccessKeyPrompt.errors
                .invalidOauthClientIdLength;
        }
        return true;
    },
};
const CLIENT_SECRET = {
    name: 'clientSecret',
    message: lib.prompts.personalAccessKeyPrompt.enterClientSecret,
    validate(val) {
        if (typeof val !== 'string') {
            return lib.prompts.personalAccessKeyPrompt.errors
                .invalidOauthClientSecret;
        }
        else if (val.length !== 36) {
            return lib.prompts.personalAccessKeyPrompt.errors
                .invalidOauthClientSecretLength;
        }
        else if (val[0] === '*') {
            return lib.prompts.personalAccessKeyPrompt.errors
                .invalidOauthClientSecretCopy;
        }
        return true;
    },
};
const PERSONAL_ACCESS_KEY_BROWSER_OPEN_PREP = {
    name: 'personalAccessKeyBrowserOpenPrep',
    type: 'list',
    message: 'Choose your preferred method of authentication',
    choices: Object.values(lib.prompts.personalAccessKeyPrompt.personalAccessKeyPromptChoices),
    default: lib.prompts.personalAccessKeyPrompt.personalAccessKeyPromptChoices
        .OPEN_BROWSER,
};
const PERSONAL_ACCESS_KEY = {
    name: 'personalAccessKey',
    message: lib.prompts.personalAccessKeyPrompt.enterPersonalAccessKey,
    transformer: (val) => {
        if (!val)
            return val;
        let res = '';
        for (let i = 0; i < val.length; i++) {
            res += '*';
        }
        return res;
    },
    validate(val) {
        if (!val || typeof val !== 'string') {
            return lib.prompts.personalAccessKeyPrompt.errors
                .invalidPersonalAccessKey;
        }
        else if (val[0] === 'â€¢') {
            return lib.prompts.personalAccessKeyPrompt.errors
                .invalidPersonalAccessKeyCopy;
        }
        return true;
    },
};
const SCOPES = {
    type: 'checkbox',
    name: 'scopes',
    message: lib.prompts.personalAccessKeyPrompt.selectScopes,
    default: [...DEFAULT_OAUTH_SCOPES],
    choices: [...OAUTH_SCOPES],
};
export const OAUTH_FLOW = [
    getCliAccountNamePromptConfig(),
    ACCOUNT_ID,
    CLIENT_ID,
    CLIENT_SECRET,
    SCOPES,
];
