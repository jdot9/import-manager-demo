import { Separator } from '@inquirer/prompts';
import { promptUser } from './promptUtils.js';
import { lib } from '../../lang/en.js';
import { uiLogger } from '../ui/logger.js';
function findTemplateByNameOrLabel(projectTemplates, templateNameOrLabel) {
    return projectTemplates.find(t => t.name === templateNameOrLabel || t.label === templateNameOrLabel);
}
export async function selectProjectTemplatePrompt(promptOptions, projectTemplates, componentTemplates) {
    const createProjectFromTemplate = !!projectTemplates && projectTemplates.length > 0;
    const createProjectFromComponents = Array.isArray(componentTemplates) && componentTemplates?.length > 0;
    const selectedComponents = [];
    if (createProjectFromComponents && promptOptions.features) {
        componentTemplates.forEach(template => {
            if (template instanceof Separator || !template.value) {
                return;
            }
            if (promptOptions.features?.includes(template.value.cliSelector || template.value.type)) {
                if (template.disabled) {
                    throw new Error(`Cannot create project with template '${template.value.type}'. Reasons: ${template.disabled}`);
                }
                selectedComponents.push(template.value);
            }
        });
    }
    const providedTemplateIsValid = createProjectFromTemplate &&
        !!promptOptions.template &&
        !!findTemplateByNameOrLabel(projectTemplates, promptOptions.template);
    const result = await promptUser([
        {
            name: 'projectTemplate',
            message: () => {
                return promptOptions.template && !providedTemplateIsValid
                    ? lib.prompts.selectProjectTemplatePrompt.errors.invalidTemplate(promptOptions.template)
                    : lib.prompts.selectProjectTemplatePrompt.selectTemplate;
            },
            when: createProjectFromTemplate && !providedTemplateIsValid,
            type: 'list',
            choices: createProjectFromTemplate
                ? projectTemplates.map(template => {
                    return {
                        name: template.label,
                        value: template,
                    };
                })
                : undefined,
        },
        {
            name: 'componentTemplates',
            message: lib.prompts.selectProjectTemplatePrompt.features,
            when: !promptOptions.features &&
                createProjectFromComponents &&
                selectedComponents.length === 0,
            type: 'checkbox',
            choices: componentTemplates,
            loop: false,
            pageSize: componentTemplates?.length,
        },
    ]);
    if (result.componentTemplates?.length === 0) {
        uiLogger.log(lib.projects.add.nothingAdded);
    }
    if (!result.componentTemplates) {
        result.componentTemplates = selectedComponents;
    }
    if (providedTemplateIsValid) {
        result.projectTemplate = findTemplateByNameOrLabel(projectTemplates, promptOptions.template);
    }
    if (projectTemplates && projectTemplates.length > 0) {
        if (!result.projectTemplate) {
            throw new Error(lib.prompts.selectProjectTemplatePrompt.errors.projectTemplateRequired);
        }
        return result;
    }
    return result;
}
