import { Tool } from '../../types.js';
import { z } from 'zod';
import { addFlag } from '../../utils/command.js';
import { absoluteCurrentWorkingDirectory } from '../project/constants.js';
import { runCommandInDir } from '../../utils/project.js';
import { formatTextContents } from '../../utils/content.js';
import { trackToolUsage } from '../../utils/toolUsageTracking.js';
import { setupHubSpotConfig } from '../../utils/config.js';
const inputSchema = {
    absoluteCurrentWorkingDirectory,
    account: z
        .string()
        .describe('The HubSpot account id or name from the HubSpot config file to use for the operation.')
        .optional(),
    json: z
        .boolean()
        .describe('Return raw JSON output instead of formatted table. Useful for programmatic access.')
        .optional(),
};
// eslint-disable-next-line @typescript-eslint/no-unused-vars
const inputSchemaZodObject = z.object({ ...inputSchema });
const toolName = 'list-cms-serverless-functions';
export class HsListFunctionsTool extends Tool {
    constructor(mcpServer) {
        super(mcpServer);
    }
    async handler({ account, json, absoluteCurrentWorkingDirectory, }) {
        setupHubSpotConfig(absoluteCurrentWorkingDirectory);
        await trackToolUsage(toolName);
        let command = 'hs function list';
        if (json) {
            command += ' --json';
        }
        if (account) {
            command = addFlag(command, 'account', account);
        }
        try {
            const { stdout, stderr } = await runCommandInDir(absoluteCurrentWorkingDirectory, command);
            return formatTextContents(stdout, stderr);
        }
        catch (error) {
            const errorMessage = error instanceof Error ? error.message : String(error);
            return {
                content: [
                    {
                        type: 'text',
                        text: `Error executing hs function list command: ${errorMessage}`,
                    },
                ],
            };
        }
    }
    register() {
        return this.mcpServer.registerTool(toolName, {
            title: 'List HubSpot CMS Serverless Functions',
            description: 'Get a list of all serverless functions deployed in a HubSpot portal/account. Shows function routes, HTTP methods, secrets, and timestamps.',
            inputSchema,
            annotations: {
                readOnlyHint: true,
                openWorldHint: true,
            },
        }, this.handler);
    }
}
