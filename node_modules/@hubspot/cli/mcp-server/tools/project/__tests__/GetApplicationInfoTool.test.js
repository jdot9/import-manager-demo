import { GetApplicationInfoTool } from '../GetApplicationInfoTool.js';
import { getConfigDefaultAccountIfExists } from '@hubspot/local-dev-lib/config';
import { http } from '@hubspot/local-dev-lib/http';
import { isHubSpotHttpError } from '@hubspot/local-dev-lib/errors/index';
import { mcpFeedbackRequest } from '../../../utils/feedbackTracking.js';
vi.mock('@modelcontextprotocol/sdk/server/mcp.js');
vi.mock('../../utils/toolUsageTracking');
vi.mock('@hubspot/local-dev-lib/http');
vi.mock('@hubspot/local-dev-lib/errors/index');
vi.mock('@hubspot/local-dev-lib/config');
vi.mock('../../../utils/feedbackTracking');
const mockMcpFeedbackRequest = mcpFeedbackRequest;
const mockGetConfigDefaultAccountIfExists = getConfigDefaultAccountIfExists;
const mockHttp = http;
const mockIsHubSpotHttpError = isHubSpotHttpError;
describe('mcp-server/tools/project/GetApplicationInfoTool', () => {
    let mockMcpServer;
    let tool;
    let mockRegisteredTool;
    beforeEach(() => {
        vi.clearAllMocks();
        // @ts-expect-error Not mocking the whole thing
        mockMcpServer = {
            registerTool: vi.fn(),
        };
        mockRegisteredTool = {};
        mockMcpServer.registerTool.mockReturnValue(mockRegisteredTool);
        mockMcpFeedbackRequest.mockResolvedValue('');
        tool = new GetApplicationInfoTool(mockMcpServer);
    });
    describe('register', () => {
        it('should register tool with correct parameters', () => {
            const result = tool.register();
            expect(mockMcpServer.registerTool).toHaveBeenCalledWith('get-applications-info', expect.objectContaining({
                title: 'Get Applications Information',
                description: expect.stringContaining('Retrieves a list of all HubSpot applications available in the current account'),
                inputSchema: expect.any(Object),
            }), expect.any(Function));
            expect(result).toBe(mockRegisteredTool);
        });
    });
    describe('handler', () => {
        const input = { absoluteCurrentWorkingDirectory: '/test/dir' };
        beforeEach(() => {
            mockGetConfigDefaultAccountIfExists.mockReturnValue({
                accountId: 123456789,
            });
            mockIsHubSpotHttpError.mockReturnValue(false);
        });
        it('should return application information successfully', async () => {
            const mockResponse = {
                data: {
                    applications: [
                        {
                            appId: 12345,
                            appName: 'Test App 1',
                        },
                        {
                            appId: 67890,
                            appName: 'Test App 2',
                        },
                    ],
                },
                status: 200,
                statusText: 'OK',
                headers: {},
                config: { headers: {} },
            };
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            mockHttp.get.mockResolvedValue(mockResponse);
            const result = await tool.handler(input);
            expect(mockGetConfigDefaultAccountIfExists).toHaveBeenCalledWith();
            expect(mockHttp.get).toHaveBeenCalledWith(123456789, {
                url: 'app/feature/utilization/public/v3/insights/apps',
            });
            expect(result).toEqual({
                content: [
                    {
                        type: 'text',
                        text: JSON.stringify(mockResponse.data, null, 2),
                    },
                ],
            });
        });
        it('should return error when account ID cannot be determined', async () => {
            mockGetConfigDefaultAccountIfExists.mockReturnValue(undefined);
            const result = await tool.handler(input);
            expect(result).toEqual({
                content: [
                    {
                        type: 'text',
                        text: 'No account ID found. Please run `hs account auth` to configure an account, or set a default account with `hs account use <account>`',
                    },
                ],
            });
            expect(mockHttp.get).not.toHaveBeenCalled();
        });
        it('should handle empty applications response', async () => {
            const mockResponse = {
                data: {
                    applications: [],
                },
                status: 200,
                statusText: 'OK',
                headers: {},
                config: { headers: {} },
            };
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            mockHttp.get.mockResolvedValue(mockResponse);
            const result = await tool.handler(input);
            expect(result).toEqual({
                content: [
                    {
                        type: 'text',
                        text: JSON.stringify(mockResponse.data, null, 2),
                    },
                ],
            });
        });
    });
});
