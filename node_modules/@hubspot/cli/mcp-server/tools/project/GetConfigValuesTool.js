import { Tool } from '../../types.js';
import { z } from 'zod';
import { formatTextContents } from '../../utils/content.js';
import { absoluteCurrentWorkingDirectory } from './constants.js';
import { getIntermediateRepresentationSchema, mapToInternalType, } from '@hubspot/project-parsing-lib';
import { isV2Project } from '../../../lib/projects/platformVersion.js';
import { getConfigDefaultAccountIfExists } from '@hubspot/local-dev-lib/config';
import { setupHubSpotConfig } from '../../utils/config.js';
const inputSchema = {
    absoluteCurrentWorkingDirectory,
    platformVersion: z
        .string()
        .describe('The platform version for the project. Located in the hsproject.json file.'),
    featureType: z
        .string()
        .describe('The type of the component to fetch the JSON schema for. This will be the `type` field in the -hsmeta.json file'),
};
// eslint-disable-next-line @typescript-eslint/no-unused-vars
const inputSchemaZodObject = z.object({
    ...inputSchema,
});
const toolName = 'get-feature-config-schema';
export class GetConfigValuesTool extends Tool {
    constructor(mcpServer) {
        super(mcpServer);
    }
    async handler({ platformVersion, featureType, absoluteCurrentWorkingDirectory, }) {
        setupHubSpotConfig(absoluteCurrentWorkingDirectory);
        try {
            if (!isV2Project(platformVersion)) {
                return formatTextContents(`Can only be used on projects with a minimum platformVersion of 2025.2`);
            }
            const accountId = getConfigDefaultAccountIfExists()?.accountId;
            if (!accountId) {
                const authErrorMessage = `No account ID found. Please run \`hs account auth\` to configure an account, or set a default account with \`hs account use <account>\``;
                return formatTextContents(authErrorMessage);
            }
            const schema = await getIntermediateRepresentationSchema({
                platformVersion,
                projectSourceDir: '',
                accountId,
            });
            const internalComponentType = mapToInternalType(featureType);
            if (schema[internalComponentType]) {
                return formatTextContents(JSON.stringify({ config: schema[internalComponentType] }));
            }
        }
        catch (error) { }
        return formatTextContents(`Unable to locate JSON schema for type ${featureType}`);
    }
    register() {
        return this.mcpServer.registerTool(toolName, {
            title: 'Fetch the JSON Schema for component',
            description: `Fetches and returns the JSON schema for the provided feature 'type' found in -hsmeta.json file.
        This should be called before editing a '-hsmeta.json' file to get the list of possible values and restrictions on those values.
        This will only work for projects with platformVersion 2025.2 and beyond`,
            inputSchema,
            annotations: {
                readOnlyHint: true,
                openWorldHint: false,
            },
        }, this.handler);
    }
}
