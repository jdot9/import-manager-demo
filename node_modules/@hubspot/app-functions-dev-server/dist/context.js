"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildContext = exports.fetchObjectContext = void 0;
const api_client_1 = require("@hubspot/api-client");
const types_1 = require("./types");
const utils_1 = require("./utils");
async function fetchObjectContext(config, objectQuery, accessToken) {
    if (!objectQuery) {
        return {};
    }
    const { logger, accountId } = config;
    const { objectId, objectTypeId, objectPropertyNames } = objectQuery;
    const propertyNames = objectPropertyNames.filter((field) => field);
    if (propertyNames.length === 0) {
        return {};
    }
    if (!accessToken) {
        const errorMessage = `Cannot fetch CRM object properties without a HubSpot API access token. This is not a problem with your code. Please copy the access token for your app at ${config.hubspotWebsiteOrigin}/private-apps/${accountId} and save it in an '.env' file in the 'app.functions' folder. For more details, please see https://developers.hubspot.com/docs/guides/crm/private-apps/serverless-functions.`;
        throw new Error(errorMessage);
    }
    let object;
    try {
        object = await getCrmObjectByHubSpotApiClient(accessToken, config.hubspotApiOrigin, objectTypeId, objectId, propertyNames);
        logger.debug(`Successfully fetched CRM object properties with objectTypeId~${objectTypeId} objectId~${objectId} accountId~${accountId}:`, object?.properties);
    }
    catch (err) {
        if ((0, types_1.isApiException)(err) && isMaybeWrongAccessToken(err)) {
            logger.debug(`HubSpot API error:\n${err.message}`);
            throw new Error(`Failed to fetch CRM object properties with objectTypeId~${objectTypeId} objectId~${objectId} accountId~${accountId}. Please check that the PRIVATE_APP_ACCESS_TOKEN specified in your '.env' file matches that of your app at ${config.hubspotWebsiteOrigin}/private-apps/${accountId}.`);
        }
        throw new Error(`Failed to fetch CRM object properties with objectTypeId~${objectTypeId} objectId~${objectId} accountId~${accountId}: ${err}`);
    }
    const propertiesToSend = (0, utils_1.filterMap)(object?.properties ?? {}, objectPropertyNames);
    return {
        propertiesToSend,
    };
}
exports.fetchObjectContext = fetchObjectContext;
function isMaybeWrongAccessToken(err) {
    /**
     * Our code controls the `objectTypeId` and `objectId` that are
     * passed to the execution service from the record page where the
     * extension is loaded. So when we get a 400 error for
     * `objectTypeId` being invalid or a 404 error for
     * `objectId` being not found, it is more likely that the
     * access token is for the wrong portal. We also include 401 errors
     * for this check as that's a clear indication of something wrong
     * with the access token.
     */
    return [400, 401, 404].includes(err.code);
}
async function getCrmObjectByHubSpotApiClient(accessToken, basePath, objectTypeId, objectId, propertyNames) {
    const hubspotClient = new api_client_1.Client({
        accessToken,
        basePath,
    });
    return await hubspotClient.crm.objects.basicApi.getById(objectTypeId, String(objectId), propertyNames);
}
async function buildContext(config, localExecutionInputs, secrets) {
    const { objectQuery, parameters, event } = localExecutionInputs;
    const objectContext = await fetchObjectContext(config, objectQuery, secrets?.PRIVATE_APP_ACCESS_TOKEN);
    return {
        propertiesToSend: {},
        parameters,
        event,
        secrets,
        ...objectContext,
    };
}
exports.buildContext = buildContext;
